<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Gallon Yin"><meta name="description" content="本文原理对大部分Android应用适用，直接进入主题。运行环境方案一：Android手机已取得Root权限，并成功安装Xposed插件，大部分国产机的系统目前对获取权限的支持都很不友好，高版本系统安装Xposed还可能造成系统变软砖等问题，仅适用爱折腾的同学"><meta name="keywords" content=""><title>企业微信打卡定位 Xposed Hook [Android] · Gallon's World</title><link rel="icon" href="/website.ico"><link rel="canonical" href="http://gallonyin.github.io/2019/04/06/Wework Location/"><link rel="alternate" href="/atom.xml" title="Gallon's World"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Gallon's World</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories" target="_self">Categories</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">企业微信打卡定位 Xposed Hook [Android]</h1><span class="post-time">Apr 6, 2019</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#运行环境"><span class="toc-text">运行环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xposed简介"><span class="toc-text">Xposed简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定位原理"><span class="toc-text">定位原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到的问题"><span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#仓库地址"><span class="toc-text">仓库地址</span></a></li></ol></div><div class="post-content"><p>本文原理对大部分 Android 应用适用，直接进入主题。</p>
<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><ul>
<li>方案一：Android 手机已取得 <strong>Root</strong> 权限，并成功安装 <strong>Xposed</strong> 插件，大部分国产机的系统目前对获取权限的支持都很不友好，高版本系统安装 Xposed 还可能造成系统变软砖等问题，仅适用爱折腾的同学。</li>
<li>方案二：在手机安装 <strong>VirtualXposed</strong>，这里是它的<a href="https://github.com/android-hacker/VirtualXposed/releases" target="_blank" rel="external">下载页面</a>，类似一个运行在 Android 上的开源虚拟机，可以把手机内的程序拖到该虚拟机里，就可以使用插件啦，推荐第二种方式。</li>
</ul>
<p>提示：1.Android 9.0 暂不支持上面两种方案。2.类似的 VirtualXposed 的软件还有<a href="https://github.com/taichi-framework/TaiChi" target="_blank" rel="external">太极</a>等。</p>
<a id="more"></a>  
<h2 id="Xposed简介"><a href="#Xposed简介" class="headerlink" title="Xposed简介"></a>Xposed简介</h2><p>Xposed框架（Xposed framework）是一套开放源代码的、在Android高权限模式下运行的框架服务，可以在不修改APK文件的情况下修改程序的运行（修改系统），简单的说，就是通过反射找到我们需要 Hook 的类、方法、属性并修改它，事实上我们几乎可以做所有事，本例我们就是利用插件修改应用运行时获取位置信息的方法，实现任意位置打卡（虽然我们并没有迟到）。<br>至于 Xposed 的原理，是替换 /system/bin/app_precesss 程序控制 zygote 进程，使得它在系统启动的过程中会加载 Xposed framework 的 XposedBridge.jar 文件（也就是每个进程开启都被会被添加一些神秘代码），应用自然就可以被劫持了。</p>
<h2 id="定位原理"><a href="#定位原理" class="headerlink" title="定位原理"></a>定位原理</h2><p>应用一般可通过多种方式进行定位，如 GPS 定位、WIFI 定位、基站定位、AGPS 定位，而且通常会混合同时使用，我们使用 Xposed 开发中，可以让应用调用一些获取位置的方法失效，而引导到我们希望应用调用的方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//基站定位相关</span></div><div class="line">android.telephony.<span class="function">TelephonyManager</span></div><div class="line">	<span class="title">getCellLocation</span><span class="params">()</span></div><div class="line">	<span class="title">getAllCellInfo</span><span class="params">()</span></div><div class="line">android.telephony.PhoneStateListener</div><div class="line">	<span class="title">onCellLocationChanged</span><span class="params">(cellLocation)</span></div><div class="line">	<span class="title">onCellInfoChanged</span><span class="params">()</span></div><div class="line"><span class="comment">//WIFI定位相关</span></div><div class="line">android.net.wifi.WifiManager</div><div class="line">	<span class="title">getScanResults</span><span class="params">()</span></div><div class="line">	<span class="title">getWifiState</span><span class="params">()</span></div><div class="line">	<span class="title">isWifiEnabled</span><span class="params">()</span></div><div class="line">	<span class="title">getMacAddress</span><span class="params">()</span></div><div class="line">	<span class="title">getSSID</span><span class="params">()</span></div><div class="line">	<span class="title">getBSSID</span><span class="params">()</span></div><div class="line"><span class="comment">//获取网络状态</span></div><div class="line">android.net.NetworkInfo</div><div class="line">	<span class="title">isConnectedOrConnecting</span><span class="params">()</span></div><div class="line">	<span class="title">isConnected</span><span class="params">()</span></div><div class="line">	<span class="title">isAvailable</span><span class="params">()</span></div><div class="line"><span class="comment">//下面是关键的，要修改经纬度坐标的方法</span></div><div class="line">android.location.LocationManager</div><div class="line">	<span class="title">getLastLocation</span><span class="params">()</span></div><div class="line">	<span class="title">getLastKnownLocation</span><span class="params">(string)</span></div><div class="line">	<span class="title">getProviders</span><span class="params">()</span></div><div class="line">	<span class="title">getBestProvider</span><span class="params">(criteria, <span class="keyword">boolean</span>)</span></div><div class="line">	<span class="title">requestLocationUpdates</span><span class="params">(...)</span></div><div class="line">	<span class="title">requestSingleUpdate</span><span class="params">(...)</span></div></pre></td></tr></table></figure></p>
<p>首先让基站定位和 WIFI 定位的方法都返回失败，让应用继续去请求其他定位方式，然后通过修改 providers 等方法返回值，最终引导应用去请求 GPS 位置，最后我们只要伪造一个 Location 返回给应用调用就可以啦。<br>具体代码请移步 <a href="https://github.com/gallonyin/weworkhook" target="_blank" rel="external">GitHub</a> 仓库，修改这些方法中调用的经纬度坐标，我们就成功把应用程序 “欺骗” 了。<br>然后只要写一个页面接入地图，把经纬度坐标传到我们的插件就大功告成了。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>笔者使用腾讯地图 API 但是发现坐标系和企业微信里的有一些不一致，所以做了一定调整适配它，并且在每次调用定位方法时做加盐处理。更具体的实现可以参考代码实现。<br>VirtualXposed 能满足日常使用，但偶尔会出现不稳定情况，可能和机型也有关，原生 Root 则很稳定。</p>
<h2 id="仓库地址"><a href="#仓库地址" class="headerlink" title="仓库地址"></a>仓库地址</h2><p> <a href="https://github.com/gallonyin/weworkhook" target="_blank" rel="external">weworkhook</a></p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2017/04/23/Git/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://gallonyin.github.io/2019/04/06/Wework Location/index.html" data-title="企业微信打卡定位 Xposed Hook [Android]" data-url="http://gallonyin.github.io/2019/04/06/Wework Location/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "gallonyin" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="social"><a href="https://github.com/gallonyin" title="github" class="iconfont icon-github"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016-2019<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Gallon Yin</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>