<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Gallon Yin"><meta name="description" content="##常见的分身/多开工具修改包名，早的时候可以，现在的应用，换包名功能就残缺不能好好用了..修改Framework（Android多用户机制。例：小米分身、访客模式等），国产手机中挺常见。但如果系统不提供该功能，自己很难开分身，本文就是告诉你怎么开了它。通过虚拟化技术实"><meta name="keywords" content=""><title>Android 系统分身及应用多开实战 frida hook [Android] · Gallon's World</title><link rel="icon" href="/website.ico"><link rel="canonical" href="http://gallonyin.github.io/2019/05/11/Android Parallel Space/"><link rel="alternate" href="/atom.xml" title="Gallon's World"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Gallon's World</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories" target="_self">Categories</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Android 系统分身及应用多开实战 frida hook [Android]</h1><span class="post-time">May 11, 2019</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Android与Linux的用户概念异同"><span class="toc-text">Android与Linux的用户概念异同</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#要使用的技术和工具"><span class="toc-text">要使用的技术和工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心代码"><span class="toc-text">核心代码</span></a></li></ol></div><div class="post-content"><p>##常见的分身/多开</p>
<ol>
<li>工具修改包名，早的时候可以，现在的应用，换包名功能就残缺不能好好用了..</li>
<li>修改 Framework（Android多用户机制。例：小米分身、访客模式等），国产手机中挺常见。但如果系统不提供该功能，自己很难开分身，本文就是告诉你怎么开了它。</li>
<li>通过虚拟化技术实现（例：360分身大师、LBE平行空间），这个应用索要权限非常高，别轻易使用非官方的该类软件。</li>
<li>以插件机制运行</li>
</ol>
<p>目前很多人都会有应用多开和系统分身的需要，多个帐号要登录在一个手机，或者体验下一个手机两个系统自由切换的感觉，完全隔离，隐私再也不怕被翻到。本文主要是通过系统隐藏 API 调用来完成系统分身，使用 Android 多用户机制，注意这里系统分为两种：1.应用在两个用户中(如 MIUI 中的系统分身) 2.影子用户，双开应用显示在原用户桌面中(如 MIUI 中的应用双开)。两种情况差不多，都是要先创建用户，然后需要显示在原桌面就再调用一下 API 即可。</p>
<p>主要手机配置足够高，你理论上可以建无数个系统分身和多开应用。<br>后面的内容全是针对<strong>多用户机制</strong>的操作办法啦。</p>
<h2 id="Android与Linux的用户概念异同"><a href="#Android与Linux的用户概念异同" class="headerlink" title="Android与Linux的用户概念异同"></a>Android与Linux的用户概念异同</h2><p>从 Android 5.0 开始引入多用户 API，都是隐藏 API 且需要系统签名并持有 managed_user 相关权限，虽然 Android 是基于 Linxu 系统，但两者账户管理体系不通，可以多用 ps 命令观察应用所属及 Android 应用的 <strong>uid</strong>，下面的 u0<em>a144 即为微信进程 uid，:push 结尾的进程则是微信的推送进程（对，这是个多进程应用），u0</em> 代表该进程运行在 <strong>id</strong> 为 <strong>0</strong> 的用户上。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell<span class="meta">@rolex</span>:/ $ ps | grep tencent</div><div class="line">u0_a144   <span class="number">29866</span> <span class="number">623</span>   <span class="number">1762984</span> <span class="number">236024</span>            <span class="number">0000000000</span> R com.tencent.mm</div><div class="line">u0_a144   <span class="number">30068</span> <span class="number">623</span>   <span class="number">1611740</span> <span class="number">98396</span> SyS_epoll_ <span class="number">0000000000</span> S com.tencent.mm:push</div></pre></td></tr></table></figure></p>
<h2 id="要使用的技术和工具"><a href="#要使用的技术和工具" class="headerlink" title="要使用的技术和工具"></a>要使用的技术和工具</h2><p>即使 root 提权应用但如果不是系统签名应用仍然不能调用成功，这也是为什么本文要使用 frida 来 hook 系统应用的原因（使用 Xposed 同样可以做到，熟悉的同学可以自己尝试）。下面直接使用代码演示，实战开始！为什么使用 frida 框架写而不用 xposed 呢，当然是因为 frida 快啦，而且手机只要 root 就可以用，不用担心 xposed 安装不上去的情况，当然，本文就不科普 frida 使用了。如果之前从没听说过 frida …<a href="https://blog.csdn.net/jiangwei0910410003/article/details/80372118" target="_blank" rel="external">推荐这篇</a><br>提示：</p>
<ol>
<li>使用了语言 python 、 js 和 java (反射) </li>
<li>本文所用设备 Nexus 6P (Android 6.0)</li>
<li>python 版本 3.7，frida 版本 12.4.0</li>
<li>查看 <a href="http://androidxref.com/6.0.0_r5/" target="_blank" rel="external">Android 源码</a> (6.0为例)，<a href="http://androidxref.com/" target="_blank" rel="external">各个版本源码友情链接</a></li>
</ol>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//一些需要用到的类</span></div><div class="line"><span class="keyword">var</span> IUserManager = Java.use(<span class="string">"android.os.IUserManager"</span>);</div><div class="line"><span class="keyword">var</span> UserManager = Java.use(<span class="string">"android.os.UserManager"</span>);</div><div class="line"><span class="keyword">var</span> UserInfo = Java.use(<span class="string">"android.content.pm.UserInfo"</span>)</div><div class="line"><span class="keyword">var</span> ActivityManagerNative = Java.use(<span class="string">"android.app.ActivityManagerNative"</span>)</div><div class="line"><span class="keyword">var</span> Integer = Java.use(<span class="string">"java.lang.Integer"</span>)</div><div class="line"><span class="keyword">var</span> int = Integer.class.getField(<span class="string">"TYPE"</span>).get(<span class="literal">null</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> Application = Java.use(<span class="string">"android.app.Application"</span>)</div><div class="line">Application.attach.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Application.attach()"</span>)</div><div class="line">    <span class="keyword">this</span>.attach(context)</div><div class="line">    </div><div class="line">    <span class="comment">//1.开始创建用户</span></div><div class="line">    <span class="keyword">var</span> mUserManager = context.getSystemService(<span class="string">"user"</span>)</div><div class="line">    mUserManager = Java.cast(mUserManager, UserManager)</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"mUserManager:"</span> + mUserManager)</div><div class="line">    <span class="keyword">var</span> mMyParallelSpaceUserInfo = mUserManager.createProfileForUser(<span class="string">"MyParallelSpace"</span>, <span class="number">32</span>, <span class="number">0</span>)</div><div class="line">    <span class="comment">//此时用户已经创建完成 mMyParallelSpaceUserInfo 及为刚创建的用户信息</span></div><div class="line">    <span class="comment">//如果不需要影子用户(双开)只需要系统分身，则第一步执行完成即可停止    </span></div><div class="line">    </div><div class="line">    <span class="comment">//2.获取创建的用户id #也可以使用 adb shell dumpsys user查看</span></div><div class="line">    <span class="comment">//注意，本例第二步是为了演示如何获取用户id，事实上第一步最后结果mMyParallelSpaceUserInfo中就有我们需要的id，如果第一步执行顺利，可直接执行第三步，及 "var id = 10" 应替换为 "var id = mMyParallelSpaceUserInfo.id.value"</span></div><div class="line">    <span class="keyword">var</span> users = mUserManager.getUsers()</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"users:"</span>+users)</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; users.size(); i++) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"user"</span> + i + <span class="string">":"</span>+users.get(i))</div><div class="line">        <span class="keyword">var</span> UserInfo_id = UserInfo.class.getDeclaredField(<span class="string">"id"</span>)</div><div class="line">        <span class="keyword">var</span> id = UserInfo_id.get(users.get(i))</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"user"</span> + i + <span class="string">":"</span>+id)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//3.该用户id设置为影子用户(本例为10) </span></div><div class="line">  	<span class="comment">//这一步是为了让创建的用户成为影子用户，在该用户安装的应用会显示在原桌面上(即双开)</span></div><div class="line">    <span class="keyword">var</span> id = <span class="number">10</span> </div><div class="line">    <span class="keyword">var</span> iActivityManager = ActivityManagerNative.class.getMethod(<span class="string">"getDefault"</span>, <span class="literal">null</span>).invoke(<span class="literal">null</span>, <span class="literal">null</span>)</div><div class="line">    <span class="keyword">var</span> method_startUserInBackground = ActivityManagerNative.class.getMethod(<span class="string">"startUserInBackground"</span>, [int])</div><div class="line">    <span class="keyword">var</span> isOK = method_startUserInBackground.invoke(iActivityManager, [Integer.$<span class="keyword">new</span>(id)])</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"startUserInBackground() userId = "</span> + id + <span class="string">" isOK = "</span> + isOK)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//frida 以 spawn 方式运行在系统应用 "设置" 上，就实现了系统应用调用</span></div><div class="line">process = device.attach(<span class="string">'com.android.settings'</span>)</div></pre></td></tr></table></figure>
<p>spawn 方式运行步骤：</p>
<ol>
<li>命令行 frida -U -f com.android.settings，提示等待下一步</li>
<li>python 运行脚本</li>
<li>命令行输入 $resume，启动”设置”应用，因为脚本 hook 了 Application.attach 方法，自动运行完成。</li>
</ol>
<p>启动微信和影子微信后查看进程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">shell<span class="meta">@rolex</span>:/ $ ps | grep tencent</div><div class="line">u10_a144 <span class="number">9054</span>  <span class="number">623</span>   <span class="number">1672156</span> <span class="number">172756</span> binder_thr <span class="number">0000000000</span> S com.tencent.mm</div><div class="line">u10_a144 <span class="number">9234</span>  <span class="number">623</span>   <span class="number">1610788</span> <span class="number">95400</span> futex_wait <span class="number">0000000000</span> S com.tencent.mm:push</div><div class="line">u0_a144   <span class="number">29866</span> <span class="number">623</span>   <span class="number">1855536</span> <span class="number">159340</span> SyS_epoll_ <span class="number">0000000000</span> S com.tencent.mm</div><div class="line">u0_a144   <span class="number">30068</span> <span class="number">623</span>   <span class="number">1605200</span> <span class="number">58676</span> SyS_epoll_ <span class="number">0000000000</span> S com.tencent.mm:push</div></pre></td></tr></table></figure>
<p>具体源码已放到 <a href="https://github.com/gallonyin/frida_collection/blob/master/frida_android/create_user/frida-nexus-user.py" target="_blank" rel="external">GitHub 仓库</a>，以上就是一次多开应用的实战操作，不同版本可能存在部分 API 小改动，也可能有的手机商系统会改动较大，本文只是抛砖引玉，有什么问题可以留言讨论，GitHub上有联系邮箱~</p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2019/04/06/Wework Location/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://gallonyin.github.io/2019/05/11/Android Parallel Space/index.html" data-title="Android 系统分身及应用多开实战 frida hook [Android]" data-url="http://gallonyin.github.io/2019/05/11/Android Parallel Space/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "gallonyin" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="social"><a href="https://github.com/gallonyin" title="github" class="iconfont icon-github"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016-2019<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Gallon Yin</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>